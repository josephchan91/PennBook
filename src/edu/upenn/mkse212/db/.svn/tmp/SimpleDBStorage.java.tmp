package edu.upenn.mkse212.db;

import java.util.ArrayList;

import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;


import com.amazonaws.services.simpledb.*;
import com.amazonaws.services.simpledb.model.*;
import com.amazonaws.auth.*;
import com.google.common.collect.ArrayListMultimap;
import com.google.common.collect.ListMultimap;

/**
 * Amazon SimpleDB key/value storage class
 * @author zives
 * @author ahae
 * modified
 * needs refactoring
 */
public class SimpleDBStorage implements IKeyValueStorage {

	AmazonSimpleDB db = null;
	boolean compress = false;
	String dbName;

	public SimpleDBStorage(String dbName, String path, String userID, String authKey, boolean compress) {
		init(dbName, path, userID, authKey);
		this.compress = compress;
	}

	@Override
	public void init(String dbNameArg, String path, String userID, String authKey) {
		db = new AmazonSimpleDBClient(new BasicAWSCredentials(userID, authKey));
		dbName = dbNameArg;

		try {
			ListDomainsResult listDomainsResult = db.listDomains();
			java.util.List<String> domainNameList  =  listDomainsResult.getDomainNames();

			if (domainNameList.contains(dbName))
				return;

			db.createDomain(new CreateDomainRequest(dbName));
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	
	@Override
	public Map<String,String> getMap(String search) {
		List<Attribute> attributeList = getAttributeList(search);
		return attributesToHashMap(search,attributeList);
	}

	@Override
	public Set<String> get(String search) {
		Set<String> result = new HashSet<String>();
		List<Attribute> attributeList = getAttributeList(search);
			// Get all matches
		for (Attribute a : attributeList) {
			if (a.getName().equals("match"))
				result.add(a.getValue());
		}

		return result;
	}
	
	public List<Attribute> getAttributeList(String search) {
		try {
			GetAttributesResult attribs = db.getAttributes(new GetAttributesRequest(dbName, search));
			java.util.List<Attribute> attributeList = attribs.getAttributes();
			return attributeList;
		} catch (Exception e) {
			e.printStackTrace();
			System.exit(1);
			return null;
		}
	}

	@Override
	public boolean exists(String search) {
		return get(search).size() > 0;
	}

	@Override
	public void put(String keyword, String value) {
		try {
			ReplaceableAttribute attr0 = new ReplaceableAttribute("keyword", keyword, false);
			ReplaceableAttribute attr1 = new ReplaceableAttribute("match", value, false);
			List<ReplaceableAttribute> list = new ArrayList<ReplaceableAttribute>(); 
			list.add(attr0);
			list.add(attr1);

			db.putAttributes(new PutAttributesRequest(dbName, keyword, list, new UpdateCondition()));
		} catch (Exception e) {
			e.printStackTrace();
			System.exit(1);
		}
	}

	@Override
	public void close() {
	}

	@Override
	public void sync() {
	}

	@Override
	public void put(String keyword, HashMap<String, String> attributes) {
		try {
			List<ReplaceableAttribute> list = new ArrayList<ReplaceableAttribute>(); 
			for ( String attrName : attributes.keySet() )
			{
				ReplaceableAttribute attr = new ReplaceableAttribute(attrName,
						attributes.get(attrName), false);
				list.add(attr);
			}
			db.putAttributes(new PutAttributesRequest(dbName, keyword, list, new UpdateCondition()));
		} catch (Exception e) {
			e.printStackTrace();
			System.exit(1);
		}
	}

	@Override
	public List<Map<String, String>> select(String query) {
		List<Map<String,String>> attributeMaps = new ArrayList<Map<String,String>>();
		SelectResult result = db.select(new SelectRequest(query));
		List<Item> simpleDbItems = result.getItems();

		HashMap<String,String> itemMap;
		for (Item item : simpleDbItems) {
			itemMap = attributesToHashMap(item.getName(),item.getAttributes());
			attributeMaps.add(itemMap);
		}	
		return attributeMaps;
	}
	
	@Override
	public List<ListMultimap<String,String>> selectMulti(String query) {
		List<ListMultimap<String,String>> attributeMaps = new ArrayList<ListMultimap<String,String>>();
		ListMultimap<String,String> itemMap;
		for (Item item : selectItems(query)) {
			itemMap = attributesToMultimap(item.getName(), item.getAttributes());
			attributeMaps.add(itemMap);
		}
		return attributeMaps;
	}
	
	@Override
	public ListMultimap<String,String> getMulti(String search) {
		List<Attribute> attributeList = getAttributeList(search);
		return attributesToMultimap(search, attributeList);
	}
	
	public void delete(String key)
	{
		db.deleteAttributes(new DeleteAttributesRequest(this.dbName,key));
	}
	
	private List<Item> selectItems(String query)
	{
		return db.select(new SelectRequest(query)).getItems();
	}
	
	private HashMap<String,String> attributesToHashMap(String name, List<Attribute> attributes) {
		HashMap<String,String> itemMap = new HashMap<String,String>();
		for (Attribute a : attributes)
		{
			itemMap.put(a.getName(), a.getValue());
		}
		itemMap.put(KEYWORD_ATTR,name);
		return itemMap;
	}
	
	private ListMultimap<String,String> attributesToMultimap(String name, List<Attribute> attributes) {
		ListMultimap<String,String> itemMap = ArrayListMultimap.create();
		for (Attribute a : attributes)
		{
			itemMap.put(a.getName(), a.getValue());
		}
		itemMap.put(KEYWORD_ATTR,name);
		return itemMap;
	}
	

	@Override
	public void put(String keyword, ListMultimap<String,String> attributes)
	{
		List<ReplaceableAttribute> list = new ArrayList<ReplaceableAttribute>(); 
		for (String attrName : attributes.keySet()) {
			for ( String value : attributes.get(attrName) ) 
			{
				ReplaceableAttribute attr = new ReplaceableAttribute(attrName,
						value, false);
				list.add(attr);
			}
		}
		db.putAttributes(new PutAttributesRequest(dbName, keyword, list, new UpdateCondition()));
	}
	
}
